<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="Guildo game development.">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/init.css">
	<link rel="stylesheet" href="assets/css/personagens.css">
</head>
<body>
<div class="container">
	
	<div id="fase">
		<div id="guildo"></div>
		<div id="mapa"></div>
	</div>

	<div class="showPosition">
		<div>Pos:</div>
		<div id="left"></div>
		<div>:</div>
		<div id="top"></div>
	</div>
	
	
	<div id="DivBlockly"></div>
	<xml id="toolbox" style="display: none">
		<category name="Comandos" colour="330">
			<block type="move_forward"></block>
			<block type="turn_left"></block>
			<block type="turn_right"></block>
		</category>
	</xml>

	<!-- Botões de ações do jogo -->
	<div class="row">
		<div class="col-sm-6 botoes-acoes">
			<button type="button" id="iniciar" class="btn btn-success"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
			<button type="button" id="parar" class="btn btn-danger"><i class="glyphicon glyphicon-stop"></i> Parar</button>
			<button type="button" id="configuracoes" class="btn btn-default"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
		</div>
	</div>

</div>
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script type="text/javascript">
	
	//Load dos commandos do blockly
	var workspace = Blockly.inject('DivBlockly',{toolbox: document.getElementById('toolbox')});

	//@see: https://blockly-demo.appspot.com/static/demos/blockfactory/index.html
	Blockly.Blocks['move_forward'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('http://www.google.com.br/');
	  	}
	}
	
	Blockly.Blocks['turn_left'] = {
	  init: function() {
		this.appendDummyInput()
		    .appendField("vire à")
		    .appendField(new Blockly.FieldDropdown([["esquerda ↺", "Esquerda"], ["direita ↻", "Direita"]]), "NAME");
		this.setInputsInline(true);
		this.setPreviousStatement(true, null);
    	this.setNextStatement(true, null);
		this.setColour(290);
		this.setTooltip('');
		this.setHelpUrl('https://pt.wikipedia.org/wiki/JavaScript');
	  }
	};
	
	Blockly.Blocks['turn_right'] = {
	  init: function() {
		this.appendDummyInput()
		    .appendField("vire à")
		    .appendField(new Blockly.FieldDropdown([["direita ↻", "Direita"], ["esquerda ↺", "Esquerda"]]), "NAME");
		this.setInputsInline(true);
		this.setPreviousStatement(true, null);
    	this.setNextStatement(true, null);
		this.setColour(290);
		this.setTooltip('');
		this.setHelpUrl('https://developers.google.com/blockly/');
	  }
	};
	
	Blockly.JavaScript['move_forward'] = function(block) {
	  // TODO: Assemble JavaScript into code variable.
	  // var code = 'moveForward(); \n';
	  return 'moveForward(\'block_id_' + block.id + '\');\n';
	};

	Blockly.JavaScript['turn_left'] = function(block) {
	  var dropdown_name = block.getFieldValue('NAME');
	  // TODO: Assemble JavaScript into code variable.
	  // var code = 'turnLeft();\n';
	  return 'turnLeft(\'block_id_' + block.id + '\');\n';
	};

	Blockly.JavaScript['turn_right'] = function(block) {
	  var dropdown_name = block.getFieldValue('NAME');
	  // TODO: Assemble JavaScript into code variable.
	  // var code = 'turnRight();\n';
	  return 'turnRight(\'block_id_' + block.id + '\');\n';
	};

	var myInterpreter = null;
	function interpret(){
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		myInterpreter = new Interpreter(code, initApi);
		Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
		Blockly.JavaScript.addReservedWords('highlightBlock');

		console.log(myInterpreter);

		myInterpreter.run();
    }

	function initApi(interpreter, scope){
	    /*
		var wrapper = function(id) {
		id = id ? id.toString() : '';
			return interpreter.createPrimitive(highlightBlock(id));
		};
		interpreter.setProperty(scope, 'highlightBlock',
		interpreter.createNativeFunction(wrapper));
		*/
	    
	    var wrapper;
	    wrapper = function(id) {
	    	moveForward(0);
	    };

	    interpreter.setProperty(scope, 'moveForward',
	    interpreter.createNativeFunction(wrapper));
	    wrapper = function(id) {
	    	turnLeft(1);
	    };

	    interpreter.setProperty(scope, 'turnLeft',
	    interpreter.createNativeFunction(wrapper));
	    wrapper = function(id) {
	    	turnRight(2);
	    };

	    interpreter.setProperty(scope, 'turnRight',
	    interpreter.createNativeFunction(wrapper));
	    
    }

    var highlightPause = false;
	function highlightBlock(id) {
		workspace.highlightBlock(id);
		highlightPause = true;
	}

	//Scripts do load do personagem e mapa do jogo
    $(document).ready(function(){
		//Carrega estado atual do personagem
		$('#guildo').addClass('front-stand');
		

		$('#top').html(charY);
		$('#left').html(charX);

		//Teste de assemble de codigo
		$("#iniciar").on('click',function(){
			runCode();
		});

		$("#parar").on('click',function(){
			showCode();
		});

    });

    //keyDown Função
	$(document).keydown(function(e){

		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {

			//Define a key atual
			currentKey = e.keyCode;
			//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
			switch(e.keyCode) {

				case 38: 
					moveChar('up');
					break;
				case 39:
					moveChar('right');
					break;
				case 40:
					moveChar('down');
					break;
				case 37:
					moveChar('left');
					break;
			}

		}

	});

	//KeyUp Função
	$(document).keyup(function(e) {

		// Não para a caminhada se o jogador está pressionando outros botões
		// Só param a caminhada se a chave que começou a caminhada é liberado
		if (e.keyCode == currentKey) {
			//Define a chave atual como false, isso permite uma nova chave de ser informada
			currentKey = false;
		}

	});

	function showCode(){
		// Generate JavaScript code and display it.
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		alert(code);
	}

	function runCode(){
		// Generate JavaScript code and run it.
		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		try {
			eval(code);
		} catch (e) {
			alert(e);
		}
	}

</script>
</body>
</html>
