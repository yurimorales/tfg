<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="Guildo game development.">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/init.css">
	<link rel="stylesheet" href="assets/css/personagem.css">
</head>
<body>
<div class="container">
	<div class="row">
		<div class="col-xs-12 col-md-4">
			<h4>Pontuação:
				<div style="display:inline-block;" id="pontuacao-atual">0</div>
			</h4>
		</div>
	</div>
	<div class="row">
		<div class="col-md-7">
			<div id="fase">
				<div id="guildo"></div>
				<div id="mapa"></div>
			</div>
		</div>
		<br/>
		<div class="col-md-5">
			<div id="DivBlockly"></div>
			<xml id="toolbox" style="display:none">
				<category name="Comandos" colour="330">
					<block type="move_right"></block>
					<block type="move_left"></block>
					<block type="move_top"></block>
					<block type="move_bottom"></block>
				</category>
			</xml>
		</div>
	</div>

	<div class="row">
		<div class="col-xs-12 col-md-8">
			<div class="col-sm-10">
				<img style="display:inline;margin-top:-40px;" src="images/heart.png" width="50" height="50"/>
				<div id="div-barra-vida">
					<div id="barra-vida"></div>
				</div>
			</div>
			<div style="margin-top:30px;" class="col-sm-10">
				<button type="button" id="iniciar" class="btn btn-success btn-xlarge"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
				<button type="button" id="reiniciar" class="btn btn-danger btn-xlarge"><i class="glyphicon glyphicon-refresh"></i> Reiniciar</button>

				<div class="btn-group dropup">
					<button type="button" class="btn btn-default btn-xlarge dropdown-toggle" type="button" data-toggle="dropdown"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
					<ul class="dropdown-menu">
						<li><a href="#" data-toggle="modal" data-target="#objetivos"><i class="glyphicon glyphicon-info-sign"></i> Objetivos</a></li>
						<li class="divider"></li>
						<li><a href="#" id="verCodigoFonte" class="dropdown-item"><i class="glyphicon glyphicon-eye-open"></i> Código fonte gerado pelo Blockly</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div id="objetivos" class="modal fade" role="dialog">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal">&times;</button>
	        <h4 class="modal-title">Objetivos</h4>
	      </div>
	      <div class="modal-body">
	        <p>Encontre a caverna, ao encontrar, entre para ir proseguir para próxima fase.</p>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
	      </div>
	    </div>
	  </div>
	</div>
<br/>
<br/>
<br/>
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script type="text/javascript">

	//Load dos commandos do blockly
	var workspace = Blockly.inject('DivBlockly',{ toolbox: document.getElementById('toolbox') });
	Blockly.JavaScript.addReservedWords('code','move_top','move_bottom','move_right','move_left');
	
	//https://blockly-demo.appspot.com/static/demos/blockfactory/index.html
	Blockly.Blocks['move_top'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para cima");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
	  	}
	}
	
	Blockly.Blocks['move_bottom'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para baixo");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
	  	}
	}


	Blockly.Blocks['move_right'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para a direita");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
	  	}
	}

	Blockly.Blocks['move_left'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para a esquerda");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
	  	}
	}

	Blockly.JavaScript['move_top'] = function(block) {
		return 'moveTop();\n';
	};

	Blockly.JavaScript['move_bottom'] = function(block) {
		return 'moveBottom();\n';
	};

	Blockly.JavaScript['move_right'] = function(block) {
		return 'moveRight();\n';
	};

	Blockly.JavaScript['move_left'] = function(block) {
		return 'moveLeft();\n';
	};
	
 	//http://stackoverflow.com/questions/31988318/google-blockly-jsinterpreter-and-interpreter-step-code
	//http://stackoverflow.com/questions/36499757/how-can-i-make-an-instance-of-a-block-of-blockly-with-javascript
	//http://stackoverflow.com/questions/20129236/creating-functions-dynamically-in-js
	//https://developers.google.com/blockly/guides/app-integration/running-javascript
	function moveTop() {
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) { // < 2
			
			currentKey = 38;
			moveChar('up');
			
			//Para a execuçao
			currentKey = false;
		}
	}

	function moveBottom(){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) { // < 2
			currentKey = 40;
			moveChar('down');
			currentKey = false;
		}
	}

	function moveRight(){
		if ($("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) { // < 2
			//Define a key atual
			currentKey = 39;
			moveChar('right');
			//Para a execuçao
			currentKey = false;

		}
	}
	
	function moveLeft(){

		if ($("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) { // < 2
			//Define a key atual
			currentKey = 37;
			moveChar('left');
			//Para a execuçao
			currentKey = false;
		}
	}
	
	function showCode(){
		// Generate JavaScript code and display it.
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		alert(code);
	}

	function runCode(){
		//Generate JavaScript code and run it.
		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		try {
			
			eval(code);
			console.log(code);
			
		} catch (e) {
			alert('Erro:'+e);
		}
	}
	
	function updateAllValues() {
		//Restaurando valo inicial das variaveis do localStorage
		if(!localStorage.getItem('pontuacao')){
			localStorage.setItem('pontuacao', 0);
		}
		if(!localStorage.getItem('percentual_vida')){
			localStorage.setItem('percentual_vida', 100);
		}
		if(!localStorage.getItem('charX')){
			localStorage.setItem('charX', 4);
		}
		if(!localStorage.getItem('charY')){
			localStorage.setItem('charY', 6);
		}

		$("#pontuacao-atual").html(localStorage.getItem('pontuacao'));
		$("#barra-vida").css("width",""+localStorage.getItem('percentual_vida')+"%");
	}

    $(document).ready(function(){
    	
    	setInterval(function() {
	    	updateAllValues();
		},3000);

		$("#iniciar").on('click',function(){
			runCode();
		});

		$("#reiniciar").on('click',function(){

			localStorage.setItem('pontuacao', 0);
			localStorage.setItem('percentual_vida', 100);
			localStorage.setItem('charX', 4);
			localStorage.setItem('charY', 6);
			//localStorage.clear();
			//location.reload(); 
			window.location = window.location;
			
		});

    	$("#verCodigoFonte").on("click",function(){
			showCode();
    	});

		//Carrega estado atual do personagem
		$('#guildo').addClass('front-stand');
    });

    //keyDown Função
	// $(document).keydown(function(e){

	// 	if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {

	// 		//Define a key atual
	// 		currentKey = e.keyCode;
	// 		//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
	// 		switch(e.keyCode) {

	// 			case 38: 
	// 				moveChar('up');
	// 				break;
	// 			case 39:
	// 				moveChar('right');
	// 				break;
	// 			case 40:
	// 				moveChar('down');
	// 				break;
	// 			case 37:
	// 				moveChar('left');
	// 				break;
	// 		}

	// 	}

	// });
	
	//KeyUp Função
	// $(document).keyup(function(e) {

	// 	//Não para a caminhada se o jogador está pressionando outros botões
	// 	//Só para a caminhada se a chave que começou a caminhada é liberado
	// 	if (e.keyCode == currentKey) {
	// 		//Define a chave atual como false, isso permite uma nova chave de ser informada
	// 		currentKey = false;
	// 	}
		
	// });
</script>
</body>
</html>