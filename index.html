<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="Guildo game development.">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/init.css">
	<link rel="stylesheet" href="assets/css/personagens.css">
</head>
<body>
<div class="container">
	
	<div id="fase">
		<div id="guildo"></div>
		<div id="mapa"></div>
	</div>

	<div class="showPosition">
		<div>Pos:</div>
		<div id="left"></div>
		<div>:</div>
		<div id="top"></div>
	</div>
	
	
	<div id="DivBlockly"></div>
	<xml id="toolbox" style="display: none">
		<category name="Comandos" colour="330">
			<block type="move_down"></block>
			<block type="move_up"></block>
			<block type="turn_left"></block>
			<block type="turn_right"></block>
		</category>
	</xml>

	<!-- Botões de ações do jogo -->
	<div class="row">
		<div class="col-sm-6 botoes-acoes">
			<button type="button" id="iniciar" class="btn btn-success"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
			<button type="button" id="parar" class="btn btn-danger"><i class="glyphicon glyphicon-stop"></i> Parar</button>
			<button type="button" id="configuracoes" class="btn btn-default"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
		</div>
	</div>

</div>
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script type="text/javascript">
	
	//Load dos commandos do blockly
	var workspace = Blockly.inject('DivBlockly',{ toolbox: document.getElementById('toolbox') });
	Blockly.JavaScript.addReservedWords('highlightBlock','code');
	
	//https://blockly-demo.appspot.com/static/demos/blockfactory/index.html
	Blockly.Blocks['move_down'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar p/ baixo");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('http://www.google.com.br/');
	  	}
	}
	
	Blockly.Blocks['move_up'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar p/ cima");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('http://www.unifra.br/');
	  	}
	}

	Blockly.Blocks['turn_left'] = {
	  init: function() {
		this.appendDummyInput()
		    .appendField("vire à")
		    .appendField(new Blockly.FieldDropdown([["esquerda ↺", "Esquerda"], ["direita ↻", "Direita"]]), "NAME");
		this.setInputsInline(true);
		this.setPreviousStatement(true, null);
    	this.setNextStatement(true, null);
		this.setColour(290);
		this.setTooltip('');
		this.setHelpUrl('https://pt.wikipedia.org/wiki/JavaScript');
	  }
	};
	
	Blockly.Blocks['turn_right'] = {
		init: function() {
			this.appendDummyInput()
			    .appendField("vire à")
			    .appendField(new Blockly.FieldDropdown([["direita ↻", "Direita"], ["esquerda ↺", "Esquerda"]]), "NAME");
			this.setInputsInline(true);
			this.setPreviousStatement(true, null);
	    	this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('https://developers.google.com/blockly/');
		}
	};
		
	Blockly.JavaScript['move_down'] = function(block) {
		var nome_bloco = block.getFieldValue('NAME');
		return 'moveDown();\n';
		//return 'moveDown(\'block_id_' + block.id + '\');\n';
	};

	Blockly.JavaScript['move_up'] = function(block) {
		return 'moveUp();\n';
		//return 'moveUp(\'block_id_' + block.id + '\');\n';
	};	

	Blockly.JavaScript['turn_left'] = function(block) {
	    var dropdown_name = block.getFieldValue('NAME');
	    //TODO: Assemble JavaScript into code variable.
	    //var code = 'turnLeft();\n';
	    // return 'turnLeft(\'block_id_' + block.id + '\');\n';
	    return 'turnLeft(\'' + dropdown_name + '\');\n';
	};

	Blockly.JavaScript['turn_right'] = function(block) {
	    var dropdown_name = block.getFieldValue('NAME');
	    //TODO: Assemble JavaScript into code variable.
	    //var code = 'turnRight();\n';
	    // return 'turnRight(\'block_id_' + block.id + '\');\n';
	    return 'turnRight(\'' + dropdown_name + '\');\n';
	};

	// var myInterpreter = null;
 //    function interpret(){
	// 	var code = Blockly.JavaScript.workspaceToCode(workspace);
		
	// 	myInterpreter = new Interpreter(code,initApi);
	// 	Blockly.JavaScript.STATEMENT_PREFIX = 'moveUp(%1);\n';
		
	// 	myInterpreter.run();
 //    }
    
	// function initApi(interpreter, scope){
		
	// 	var wrapper = function(id) {
	// 		id = id ? id.toString() : '';
	// 		return interpreter.createPrimitive(moveUp(id));
	// 	};
	// 	interpreter.setProperty(scope, 'moveUp',
	// 	interpreter.createNativeFunction(wrapper));
		
 //    }
		
	// var highlightPause = false;
	function moveDown() {
		// highlightPause = true;
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0){
			console.log("Caminhe para baixo, pos[" + charX + "," + charY + "]");
			//Define a key atual
			// currentKey = 40;
			// moveChar('down');
			var cont = 0
			while(cont < 5){
				console.log("contador "+cont);
				cont++;
				
				currentKey = 40;
				moveChar('down');

				if(cont == 4){
					//Para a execuçao
					currentKey = false;
					return;
				}

			}

		}
	}

	function moveUp(){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			console.log("Caminhe para cima, pos[" + charX + "," + charY + "]");
			//Define a key atual
			currentKey = 38;
			moveChar('up');
			//Para a execuçao
			currentKey = false;
		}
	}

	function turnRight(comando){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			console.log('Vire a '+comando+', estou ordenando!');
			//Define a key atual
			currentKey = 39;
			moveChar('right');
			//Para a execuçao
			currentKey = false;

		}
	}
	
	function turnLeft(comando){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			console.log('Vire a '+comando+', estou ordenando!');
			//Define a key atual
			currentKey = 37;
			moveChar('left');
			//Para a execuçao
			currentKey = false;
		}
	}
    
	//@see: http://stackoverflow.com/questions/31988318/google-blockly-jsinterpreter-and-interpreter-step-code
	//@see: http://stackoverflow.com/questions/36499757/how-can-i-make-an-instance-of-a-block-of-blockly-with-javascript
	//http://stackoverflow.com/questions/20129236/creating-functions-dynamically-in-js
	//https://developers.google.com/blockly/guides/app-integration/running-javascript
	function showCode(){
		// Generate JavaScript code and display it.
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		alert(code);
	}

	function runCode(){
		//Generate JavaScript code and run it.
		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		try {

			console.log("Codigo sendo executado: "+code);
			eval(code);
			
		} catch (e) {
			alert('Erro:'+e);
		}
	}
	
	//Scripts do load do personagem e mapa do jogo
    $(document).ready(function(){
    	
    	//Teste de assemble de codigo
		$("#iniciar").on('click',function(){
			runCode();
		});
		$("#parar").on('click',function(){
			showCode();
		});
    	
		//Carrega estado atual do personagem
		$('#guildo').addClass('front-stand');
		$('#top').html(charY);
		$('#left').html(charX);
    });

    //keyDown Função
	$(document).keydown(function(e){

		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {

			//Define a key atual
			currentKey = e.keyCode;
			//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
			switch(e.keyCode) {

				case 38: 
					moveChar('up');
					break;
				case 39:
					moveChar('right');
					break;
				case 40:
					moveChar('down');
					break;
				case 37:
					moveChar('left');
					break;
			}

		}

	});

	//KeyUp Função
	$(document).keyup(function(e) {

		//Não para a caminhada se o jogador está pressionando outros botões
		//Só para a caminhada se a chave que começou a caminhada é liberado
		if (e.keyCode == currentKey) {
			//Define a chave atual como false, isso permite uma nova chave de ser informada
			currentKey = false;
		}
		
	});

</script>
</body>
</html>
