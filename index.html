<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="Guildo game development.">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/init.css">
	<link rel="stylesheet" href="assets/css/personagem.css">
</head>
<body>
<div class="container">
	<div class="row">
		<div class="col-xs-12 col-md-4">
			<h4>Pontuação:
				<div style="display:inline-block;" id="pontuacao-atual">0
					<!-- <div style="float:left" id="left"></div>:<div style="float:left" id="top"></div></div> -->
			</h4>
		</div>
	</div>
	<div class="row">
		<div class="col-md-7">
			<div id="fase">
				<div id="guildo"></div>
				<div id="mapa"></div>
			</div>
		</div>
		<br/>
		<div class="col-md-5">
			<div id="DivBlockly"></div>
			<xml id="toolbox" style="display:none">
				<category name="Comandos" colour="330">
					<block type="move"></block>
					<block type="turn_left"></block>
					<block type="turn_right"></block>
				</category>
			</xml>
		</div>
	</div>

	<div class="row">
		<div class="col-xs-12 col-md-8">
			<div class="col-sm-10">
				<img style="display:inline;margin-top:-40px;" src="images/heart.png" width="50" height="50"/>
				<div id="div-barra-vida">
					<div id="barra-vida" style="width:100%;"></div>
				</div>
			</div>
			<div style="margin-top:30px;" class="col-sm-10">
				<button type="button" id="iniciar" class="btn btn-success btn-xlarge"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
				<button type="button" id="reiniciar" class="btn btn-danger btn-xlarge"><i class="glyphicon glyphicon-refresh"></i> Reiniciar</button>
				<button type="button" id="configs" class="btn btn-default btn-xlarge"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
			</div>
		</div>
	</div>
	<br/>
	<br/>
	<br/>
	<!-- <div class="showPosition">
		<div>Pos:</div>
		<div id="left"></div>
		<div>:</div>
		<div id="top"></div>
	</div>-->
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script type="text/javascript">
	
	//Load dos commandos do blockly
	var workspace = Blockly.inject('DivBlockly',{ toolbox: document.getElementById('toolbox') });
	Blockly.JavaScript.addReservedWords('highlightBlock','code');
	
	//https://blockly-demo.appspot.com/static/demos/blockfactory/index.html
	Blockly.Blocks['move'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('http://www.google.com.br/');
	  	}
	}
	
	Blockly.Blocks['turn_left'] = {
		init: function() {
			this.appendDummyInput()
			    .appendField("vire à")
			    .appendField(new Blockly.FieldDropdown([["esquerda ↺", "Esquerda"], ["direita ↻", "Direita"]]), "NAME");
			this.setInputsInline(true);
			this.setPreviousStatement(true, null);
	    	this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('https://pt.wikipedia.org/wiki/JavaScript');
		}
	};
	
	Blockly.Blocks['turn_right'] = {
		init: function() {
			this.appendDummyInput()
			    .appendField("vire à")
			    .appendField(new Blockly.FieldDropdown([["direita ↻", "Direita"], ["esquerda ↺", "Esquerda"]]), "NAME");
			this.setInputsInline(true);
			this.setPreviousStatement(true, null);
	    	this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('');
			this.setHelpUrl('https://developers.google.com/blockly/');
		}
	};
		
	Blockly.JavaScript['move'] = function(block) {
		// You can show a blockly warning
		//if( charY >= 7 ) block.setWarningText("You get it!");
		return 'move();\n';
		//return 'move(\'block_id_' + block.id + '\');\n';
	};

	Blockly.JavaScript['turn_left'] = function(block) {
	    var dropdown_name = block.getFieldValue('NAME');
	    //TODO: Assemble JavaScript into code variable.
	    //var code = 'turnLeft();\n';
	    // return 'turnLeft(\'block_id_' + block.id + '\');\n';
	    return 'turnLeft(\'' + dropdown_name + '\');\n';
	};

	Blockly.JavaScript['turn_right'] = function(block) {
	    var dropdown_name = block.getFieldValue('NAME');
	    //TODO: Assemble JavaScript into code variable.
	    //var code = 'turnRight();\n';
	    // return 'turnRight(\'block_id_' + block.id + '\');\n';
	    return 'turnRight(\'' + dropdown_name + '\');\n';
	};

	// var myInterpreter = null;
 //    function interpret(){
	// 	var code = Blockly.JavaScript.workspaceToCode(workspace);
		
	// 	myInterpreter = new Interpreter(code,initApi);
	// 	Blockly.JavaScript.STATEMENT_PREFIX = 'moveUp(%1);\n';
		
	// 	myInterpreter.run();
 //    }
    
	// function initApi(interpreter, scope){
		
	// 	var wrapper = function(id) {
	// 		id = id ? id.toString() : '';
	// 		return interpreter.createPrimitive(moveUp(id));
	// 	};
	// 	interpreter.setProperty(scope, 'moveUp',
	// 	interpreter.createNativeFunction(wrapper));
		
 //    }

 	//http://stackoverflow.com/questions/31988318/google-blockly-jsinterpreter-and-interpreter-step-code
	//http://stackoverflow.com/questions/36499757/how-can-i-make-an-instance-of-a-block-of-blockly-with-javascript
	//http://stackoverflow.com/questions/20129236/creating-functions-dynamically-in-js
	//https://developers.google.com/blockly/guides/app-integration/running-javascript
	
	// var highlightPause = false;
	function move() {
		// highlightPause = true;
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0){
			console.log("Ordeno que vc caminhe... pos[" + charX + "," + charY + "]");
			
			//currentKey = 40;
			//moveChar('down');
			currentKey = 40;
			moveChar('down');
			
			//Para a execuçao
			currentKey = false;
		}
	}

	function turnRight(direcao){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			console.log('Vire a '+direcao+', estou ordenando!');
			//Define a key atual
			currentKey = 39;
			moveChar('right');
			//Para a execuçao
			currentKey = false;

		}
	}
	
	function turnLeft(direcao){
		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			console.log('Vire a '+direcao+', estou ordenando!');
			//Define a key atual
			currentKey = 37;
			moveChar('left');
			//Para a execuçao
			currentKey = false;
		}
	}
    
	
	function showCode(){
		// Generate JavaScript code and display it.
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		alert(code);
	}

	function runCode(){
		//Generate JavaScript code and run it.
		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		try {

			console.log(code);
			eval(code);
			
		} catch (e) {
			alert('Erro:'+e);
		}
	}
	
    $(document).ready(function(){
    	
		$("#iniciar").on('click',function(){
			runCode();
		});

		$("#reiniciar").on('click',function(){
			location.reload(); 
		});

    	$("#configs").on("click",function(){
			showCode();
    	});

		//Carrega estado atual do personagem
		$('#guildo').addClass('front-stand');
		$('#top').html(charY);
		$('#left').html(charX);
    });

    //keyDown Função
	$(document).keydown(function(e){

		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {

			//Define a key atual
			currentKey = e.keyCode;
			//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
			switch(e.keyCode) {

				case 38: 
					moveChar('up');
					break;
				case 39:
					moveChar('right');
					break;
				case 40:
					moveChar('down');
					break;
				case 37:
					moveChar('left');
					break;
			}

		}

	});

	//KeyUp Função
	$(document).keyup(function(e) {

		//Não para a caminhada se o jogador está pressionando outros botões
		//Só para a caminhada se a chave que começou a caminhada é liberado
		if (e.keyCode == currentKey) {
			//Define a chave atual como false, isso permite uma nova chave de ser informada
			currentKey = false;
		}
		
	});

</script>
</body>
</html>
