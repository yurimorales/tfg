<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/default.css">
	<link rel="stylesheet" href="assets/css/personagem.css">
</head>
<body>
<div class="container">
	<div class="row">
		<div class="col-xs-12 col-md-4">
			<h4>Pontuação:
				<div id="pontuacao-atual">0</div>
			</h4>
		</div>
	</div>
	<div class="row">
		<div class="col-md-7">
			<div id="fase">
				<div id="guildo"></div>
				<div id="mapa"></div>
			</div>
		</div>
		<br/>

		<div class="col-md-5">
			<div id="DivBlockly"></div>
			<xml id="toolbox" style="display:none">
				<category name="Comandos" colour="330">
					<block type="avancar"></block>
					<block type="vire"></block>
					<block type="repeticao"></block>
					<block type="condicional"></block>
				</category>
			</xml>
		</div>
	</div>

	<div class="row">
		<div class="col-xs-12 col-md-8">

			<div style="width: 400px; margin: auto auto;">
				<div style="float:left;">Pos: </div>
				<div id="left" style="float:left;"></div>
				<div style="float:left;">:</div>
				<div id="top" style="float:left;"></div>
				<div id="debug" style="float:left;margin-left:200px;"></div>
			</div>

			<div class="col-sm-10">
				<img style="display:inline;margin-top:-40px;" src="images/heart.png" width="50" height="50" />
				<div id="div-barra-vida">
					<div id="barra-vida"></div>
				</div>
			</div>
			<div style="margin-top:30px;" class="col-sm-10">
				<button type="button" id="iniciar" class="btn btn-success btn-xlarge"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
				<button type="button" id="reiniciar" class="btn btn-danger btn-xlarge"><i class="glyphicon glyphicon-refresh"></i> Reiniciar</button>

				<div class="btn-group dropup">
					<button type="button" class="btn btn-default btn-xlarge dropdown-toggle" type="button" data-toggle="dropdown"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
					<ul class="dropdown-menu">
						<li><a href="#" data-toggle="modal" data-target="#objetivos"><i class="glyphicon glyphicon-info-sign"></i> Objetivos</a></li>
						
						<li class="divider"></li>
						<li><a href="#" id="verCodigoFonte" class="dropdown-item"><i class="glyphicon glyphicon-eye-open"></i> Código fonte gerado pelo Blockly</a></li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div id="objetivos" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title"><i class="glyphicon glyphicon-star"></i> Objetivos</h4>
				</div>
				<div class="modal-body">
					<p>Encontre a caverna!</p>
					<p>Ao encontrar, entre e prossiga para a próxima fase.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
				</div>
			</div>
  		</div>
	</div>
<br/>
<br/>
<br/>
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script>
	
	//Load blocos de commandos do Blockly
	var workspace = Blockly.inject('DivBlockly',{ toolbox: document.getElementById('toolbox') });
	
	Blockly.Blocks['avancar'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Move o personagem para a frente');
	  	}
	};
	
	Blockly.Blocks['vire'] = {
		init: function() {
			this.appendDummyInput()
			    .appendField("vire à")
			    .appendField(new Blockly.FieldDropdown([["esquerda ↺", "Esquerda"], ["direita ↻", "Direita"]]), "NAME");
			this.setInputsInline(true);
			this.setPreviousStatement(true, null);
	    	this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Vire o personagem 90 graus para a direita ou esquerda');
			this.setHelpUrl('https://pt.wikipedia.org/wiki/JavaScript');
		}
	};

	Blockly.Blocks['repeticao'] = {
		init: function() {
		    this.appendDummyInput()
		        .appendField("enquanto nao encontrar a caverna, faça");
		    this.setPreviousStatement(true, null);
		    this.setNextStatement(true, null);
		    this.setColour(150);
		    this.setTooltip('');
		    this.setHelpUrl('http://www.example.com/');
		}
		/*
		init: function() {
			this.appendDummyInput()
			.appendField("enquanto nao encontrar a caverna")
			this.appendStatementInput("NAME")
			.setCheck(null)
			.appendField("faça");
			this.setPreviousStatement(true, null);
			this.setColour(150);
			this.setTooltip('');
			this.setHelpUrl('http://www.example.com/');
		}
		*/
	};

	Blockly.Blocks['condicional'] = {
  		init: function() {
			this.appendDummyInput()
			.appendField("Se caminho a")
			.appendField(new Blockly.FieldDropdown([["frente", "Frente"], ["direita", "Direita"], ["esquerda", "Esquerda"]]), "direcao");
			this.appendStatementInput("NAME")
			.setCheck(null)
			.appendField("faça");
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(210);
			this.setTooltip('Se existe caminho na direcao escolhida, entao faça algumas acoes');
			this.setHelpUrl('https://en.wikipedia.org/wiki/Conditional_(computer_programming)');
	  	}

	};

	function showCode(){
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var codigo = Blockly.JavaScript.workspaceToCode(workspace);
		alert(codigo);
	}

	function runCode(){

		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

		Blockly.JavaScript.addReservedWords('code','avancar','vire','condicional','repeticao');
		var code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

		try {
			
			eval(code);
			alert(code);

		} catch (e) {
			alert('Erro:'+e);
		}
		
	}

	$(document).ready(function(){

		$('#guildo').addClass('front-stand');
		$('#top').html(charY);
		$('#left').html(charX);

    	//Atualiza valores globais do jogo
    	/*
		setInterval(function(){
			updateAllValues();
		},3000);
		*/

		$("#iniciar").on('click',function(){
			runCode();
		});
		
		$("#reiniciar").on('click',function(){
			
			localStorage.setItem('pontuacao',0);
			localStorage.setItem('percentual_vida',100);
			//localStorage.setItem('charX',4);
			//localStorage.setItem('charY',6);
			location.reload();
			
		});

		$("#verCodigoFonte").on("click",function(){
			showCode();
		});
		
    });

	    //keyDown Função
	$(document).keydown(function(e){

		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
			switch(e.keyCode) {

				case 38: 
					currentKey = 38;
					moveChar('up');
					break;

				case 39:
					currentKey = 39;
					moveChar('right');
					break;

				case 40:
					currentKey = 40;
					moveChar('down');
					break;

				case 37:
					currentKey = 37;
					moveChar('left');
					break;
			}

		}

		$('#debug').html('Current Key: '+currentKey);

	});
	
	//KeyUp Função
	$(document).keyup(function(e) {

		//Não para a caminhada se o jogador está pressionando outros botões
		//Só para a caminhada se a chave que começou a caminhada é liberado
		if (e.keyCode == currentKey) {
			//Define a chave atual como false, isso permite uma nova chave de ser informada
			currentKey = false;
		}
		
	});


</script>
</body>
</html>