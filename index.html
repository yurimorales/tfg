<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="guildo-game" value="notranslate">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="">
	<title>Guildo Game</title>
	<link rel="stylesheet" href="assets/components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/default.css">
	<link rel="stylesheet" href="assets/css/personagem.css">
</head>
<body>
<div class="container">
	<div class="row">
		<div style="display:none" class="col-xs-12 col-md-4">
			<h4>Pontuação:
				<div id="pontuacao-atual">0</div>
			</h4>
		</div>
	</div>
	<div class="row">
		<div class="col-md-7">
			<div id="fase">
				<div id="guildo"></div>
				<div id="mapa"></div>
			</div>
		</div>
		<br/>

		<div class="col-md-5">
			<div id="DivBlockly"></div>
			<xml id="toolbox" style="display:none">
				<category name="Comandos" colour="330">
					<block type="mover_cima"></block>
					<block type="mover_baixo"></block>
					<block type="mover_direita"></block>
					<block type="mover_esquerda"></block>
					<block type="vire"></block>
					<block type="decisao"></block>
					<block type="controls_repeat_ext">
						<value name="TIMES">
							<block type="math_number">
								<field name="NUM">5</field>
							</block>
						</value>
					</block>
					<!--<block type="loop"></block>-->
				</category>
			</xml>
		</div>
	</div>

	<div class="row">
		<div class="col-xs-12 col-md-8">

			<div style="display:none;width:400px;margin:auto;">
				<div style="float:left;">Pos: </div>
				<div id="left" style="float:left;"></div>
				<div style="float:left;">:</div>
				<div id="top" style="float:left;"></div>
				<div id="debug" style="float:left;margin-left:200px;"></div>
			</div>

			<div class="col-sm-10">
				<img style="display:inline;margin-top:-40px;" src="images/heart.png" width="50" height="50" />
				<div id="div-barra-vida">
					<div id="barra-vida"></div>
				</div>
			</div>
			<div style="margin-top:30px;" class="col-sm-10">
				<button type="button" id="iniciar" class="btn btn-success btn-xlarge"><i class="glyphicon glyphicon-play"></i> Iniciar</button>
				<button type="button" id="reiniciar" class="btn btn-danger btn-xlarge"><i class="glyphicon glyphicon-refresh"></i> Reiniciar</button>

				<div class="btn-group dropup">
					<button type="button" class="btn btn-default btn-xlarge dropdown-toggle" type="button" data-toggle="dropdown"><i class="glyphicon glyphicon-cog"></i> Configurações</button>
					<ul class="dropdown-menu">
						<li><a href="#" data-toggle="modal" data-target="#objetivos"><i class="glyphicon glyphicon-info-sign"></i> Objetivos</a></li>
						
						<li class="divider"></li>
						<li><a href="#" id="verCodigoFonte" class="dropdown-item"><i class="glyphicon glyphicon-eye-open"></i> Código fonte gerado</a></li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div id="objetivos" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title"><i class="glyphicon glyphicon-star"></i> Objetivos</h4>
				</div>
				<div class="modal-body">
					<p>Encontre a caverna!</p>
					<p>Ao encontrar, entre e prossiga para a próxima fase.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
				</div>
			</div>
  		</div>
	</div>
<br/>
<br/>
<br/>
<script src="assets/components/google-blockly/blockly_compressed.js"></script>
<script src="assets/components/google-blockly/javascript_compressed.js"></script>
<script src="assets/components/google-blockly/blocks_compressed.js"></script>
<script src="assets/components/google-blockly/msg/js/pt-br.js"></script>
<script src="assets/components/jquery/dist/jquery.min.js"></script>
<script src="assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="assets/js/script.js"></script>
<script>
	
	//Load blocos de commandos do Blockly
	var workspace = Blockly.inject('DivBlockly',{ toolbox: document.getElementById('toolbox') });
	Blockly.JavaScript.addReservedWords('code','runCode','vire','loop','decisao','mover_cima','mover_baixo','mover_direita','mover_esquerda');

	Blockly.Blocks['mover_cima'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para cima");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Move o personagem para cima');
	  	}
	};

	Blockly.Blocks['mover_baixo'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para baixo");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Move o personagem para abaixo');
	  	}
	};
	
	Blockly.Blocks['mover_direita'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para a direita");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Move o personagem para a direita');
	  	}
	};

	Blockly.Blocks['mover_esquerda'] = {
		init: function() {
			this.appendDummyInput()
				.appendField("avançar para esquerda");
			this.setInputsInline(false);
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Move o personagem para a esquerda');
	  	}
	};

	Blockly.Blocks['vire'] = {
		init: function() {
			this.appendDummyInput()
			    .appendField("vire à")
			    .appendField(new Blockly.FieldDropdown([["esquerda ↺", "LEFT"], ["direita ↻", "RIGHT"]]), "VIRE");
			this.setInputsInline(true);
			this.setPreviousStatement(true, null);
	    	this.setNextStatement(true, null);
			this.setColour(290);
			this.setTooltip('Vire o personagem 90 graus para a direita ou esquerda');
			this.setHelpUrl('https://pt.wikipedia.org/wiki/JavaScript');
		}
	};

	Blockly.Blocks['decisao'] = {
		init: function() {
			this.appendDummyInput()
			.appendField("se caminho a")
			.appendField(new Blockly.FieldDropdown([["esquerda ↺", "LEFT"], ["direita ↻", "RIGHT"]]), "OPTION");
			this.appendStatementInput("FAÇA")
			.setCheck(null)
			.appendField("faça");
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(230);
			this.setTooltip('Se há caminho na direção informada, então faça algumas ações');
			this.setHelpUrl('https://github.com/google/blockly/wiki/IfElse');
		}
	};
	
	Blockly.Blocks['loop'] = {
		init: function() {
			this.appendDummyInput()
			.appendField("repetir até encontrar a caverna");
			this.appendStatementInput("FAÇA")
			.setCheck(null)
			.appendField("faça");
			this.setPreviousStatement(true, null);
			this.setNextStatement(true, null);
			this.setColour(120);
			this.setTooltip('');
			this.setHelpUrl('https://github.com/google/blockly/wiki/Loops');
		}
	};
	
	//Mostra codigos gerados pela montagem dos blocos
	function showCode(){
		
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
		var codigo = Blockly.JavaScript.workspaceToCode(workspace);
		alert(codigo);
		
	}
	
	//Executa codigos javascript gerados
	function runCode(){
		
		window.LoopTrap = 1000;
		Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
		Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

		var runCode = Blockly.JavaScript.workspaceToCode(workspace);

		try {
				
			eval(runCode);
				
		} catch (e) {
			alert('Erro:'+e);
		}
					
	}

	$(document).ready(function(){

		$('#guildo').addClass('front-stand');
		$('#top').html(charY);
		$('#left').html(charX);

    	//Atualiza valores globais do jogo
    	/*
		setInterval(function(){
			atualizaValores();
		},3000);
		*/

		$("#iniciar").on('click',function(){
			runCode();
		});
		
		$("#reiniciar").on('click',function(){
			
			localStorage.setItem('pontuacao',0);
			localStorage.setItem('percentual_vida',100);
			//localStorage.setItem('charX',4);
			//localStorage.setItem('charY',6);
			location.reload();
			
		});

		$("#verCodigoFonte").on("click",function(){
			showCode();
		});
		
    });

    //keyDown
	$(document).keydown(function(e){

		if (!currentKey && $("#guildo").queue("fx").length == 0 && $('#mapa').queue("fx").length == 0 ) {
			//Executa a função de movimento do personagem moveChar("<direcao a ser tomada>")
			switch(e.keyCode) {

				case 38: 
					currentKey = 38;
					moveChar('up');
					encontrouDestino();
					break;

				case 39:
					currentKey = 39;
					moveChar('right');
					encontrouDestino();
					break;

				case 40:
					currentKey = 40;
					moveChar('down');
					encontrouDestino();
					break;

				case 37:
					currentKey = 37;
					moveChar('left');
					encontrouDestino();
					break;
			}

		}

		$('#debug').html('Current Key: '+currentKey);

	});
	
	//KeyUp
	$(document).keyup(function(e) {

		//Não para a caminhada se o jogador está pressionando outros botões
		//Só para a caminhada se a chave que começou a caminhada é liberado
		if (e.keyCode == currentKey) {
			//Define a chave atual como false, isso permite uma nova chave de ser informada
			currentKey = false;
		}
		
	});
</script>
</body>
</html>